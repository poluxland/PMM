<div class="row mb-4">
  <div class="col-sm-4">
    <%= form_with url: inf_path, method: :get, local: true do |f| %>
      <div class="form-group">
        <label><strong>Seleccionar año</strong></label>
        <%= f.select :year,
                     options_for_select((2018..Time.current.year).to_a.reverse, @year),
                     {}, class: "form-control",
                        onchange: "this.form.submit();" %>
      </div>
    <% end %>
  </div>
</div>



<h2>Informe Camiones <%= @year %></h2>

<hr>

<div class="row">
  <div class="col-sm-4">
    <h4>Resumen general</h4>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th scope="row">Total de camiones <%= @year %>:</th>
          <td><%= @total_trucks_2025 %></td>
        </tr>
        <tr>
          <th scope="row">Espera ≤ 60 min:</th>
          <td><%= @wait_le_60_count %></td>
        </tr>
        <tr>
          <th scope="row">Espera &gt; 60 min:</th>
          <td><%= @wait_gt_60_count %></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="col-sm-4">
    <h4>Conchuela</h4>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th scope="row">Conchuela total:</th>
          <td><%= @conchuela_total %></td>
        </tr>
        <tr>
          <th scope="row">Conchuela Planos:</th>
          <td><%= @conchuela_planos_total %></td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="col-sm-4">
    <h4>Planos – métricas</h4>
    <table class="table table-sm table-bordered">
      <tbody>
        <tr>
          <th scope="row">Media:</th>
          <td><%= @planos_media.round(2) %> min</td>
        </tr>
        <tr>
          <th scope="row">Mediana:</th>
          <td><%= @planos_mediana.round(2) %> min</td>
        </tr>
        <tr>
          <th scope="row">Desv. estándar:</th>
          <td><%= @planos_desv_est.round(2) %> min</td>
        </tr>
        <tr>
          <th scope="row">Outliers:</th>
          <td><%= @planos_outliers_count %></td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<br>


<br>

<div class="row">
  <div class="col-sm-4">
    <h5>Cumplimiento espera (todos)</h5>
    <% if @wait_pie_data.values.sum.zero? %>
      <p>No hay datos para mostrar.</p>
    <% else %>
      <%= pie_chart @wait_pie_data, legend: "right", height: "300px" %>
    <% end %>
  </div>

  <div class="col-sm-4">
    <h5>Conchuela por tipo</h5>
    <% if @conchuela_by_tipo.blank? %>
      <p>No hay datos de Conchuela.</p>
    <% else %>
      <%= pie_chart @conchuela_by_tipo, legend: "right", height: "300px" %>
    <% end %>
  </div>

  <div class="col-sm-4">
    <h5>Cumplimiento Espera Planos</h5>
    <% if (@planos_le_60_count + @planos_gt_60_count).zero? %>
      <p>No hay datos de PLANOS.</p>
    <% else %>
      <%= pie_chart @planos_wait_pie_data, legend: "right", height: "300px" %>
    <% end %>
  </div>
</div>

<br><br>


<div class="row">
  <div class="col-sm-12">
    <h4>Espera promedio mensual por MMPP</h4>
    <% if @avg_wait_by_mmpp_month.blank? %>
      <p>No hay datos para mostrar.</p>
    <% else %>
      <%= line_chart @avg_wait_by_mmpp_month,
                     xtitle: "Fecha",
                     ytitle: "Espera promedio (min)",
                     legend: "bottom" %>
    <% end %>
  </div>
</div>

<br>


<div class="row">
  <div class="col-sm-12">
    <h4>Espera promedio mensual Planos</h4>
    <% if @planos_avg_wait_by_month.blank? %>
      <p>No hay datos de PLANOS.</p>
    <% else %>
      <%= line_chart @planos_avg_wait_by_month,
                     xtitle: "Fecha",
                     ytitle: "Espera promedio (min)" %>
    <% end %>
  </div>
</div>

<br>


<div class="row">
  <div class="col-sm-12">
    <h4>Tabla m por MMPP mes a mes</h4>

    <% if @avg_wait_by_mmpp_month_raw.blank? %>
      <p>No hay datos para mostrar.</p>
    <% else %>
      <table class="table">
        <thead class="thead-dark">
          <tr>
            <th>Mes</th>
            <th>MMPP</th>
            <th>Espera media (min)</th>
          </tr>
        </thead>
        <tbody>
          <% @avg_wait_by_mmpp_month_raw.each do |(mmpp_name, date), avg_wait| %>
  <tr>
    <td><%= l(date.to_date, format: "%Y-%m") %></td>
    <td><%= mmpp_name %></td>
    <td><%= avg_wait.to_f.round(2) %></td>
  </tr>
<% end %>

        </tbody>
      </table>
    <% end %>
  </div>
</div>

<br>


<a class="btn btn-primary" href="#" onclick="window.print();return false;">Imprimir reporte</a>
